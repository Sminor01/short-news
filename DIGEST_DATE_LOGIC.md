# Логика расчета дат для дайджестов

## Обзор

Система дайджестов использует улучшенную логику расчета дат для обеспечения корректной фильтрации новостей.

## Типы дайджестов

### 1. Daily Digest (Ежедневный дайджест)

**Период**: Текущий день с 00:00:00 до 23:59:59

**Пример**:
- Текущее время: 14.10.2025 16:35 UTC
- Диапазон новостей: 14.10.2025 00:00 - 14.10.2025 23:59

**Использование**:
```python
digest_service = DigestService(db)
digest = await digest_service.generate_user_digest(
    user_id=user_id,
    period="daily"
)
```

### 2. Weekly Digest (Еженедельный дайджест)

**Период**: Текущая неделя с воскресенья 00:00:00 до субботы 23:59:59

**Обоснование**: Неделя начинается с воскресенья в соответствии с:
- Календарями США и западных стран
- GitHub Activity Calendar
- Многими системами отчетности

**Пример**:
- Текущее время: 14.10.2025 (вторник) 16:35 UTC
- Диапазон новостей: 12.10.2025 (воскресенье) 00:00 - 18.10.2025 (суббота) 23:59

**Использование**:
```python
digest_service = DigestService(db)
digest = await digest_service.generate_user_digest(
    user_id=user_id,
    period="weekly"
)
```

### 3. Custom Digest (Пользовательский дайджест)

**Период**: Произвольный диапазон дат, указанный пользователем

**Пример**:
```python
from datetime import datetime

digest_service = DigestService(db)
digest = await digest_service.generate_user_digest(
    user_id=user_id,
    period="custom",
    custom_date_from=datetime(2025, 10, 1),
    custom_date_to=datetime(2025, 10, 7)
)
```

## Примеры расчета недель

| Текущая дата | День недели | Начало недели | Конец недели |
|--------------|-------------|---------------|--------------|
| 14.10.2025 | Вторник | 12.10.2025 (Вс) | 18.10.2025 (Сб) |
| 13.10.2025 | Понедельник | 12.10.2025 (Вс) | 18.10.2025 (Сб) |
| 12.10.2025 | Воскресенье | 12.10.2025 (Вс) | 18.10.2025 (Сб) |
| 11.10.2025 | Суббота | 05.10.2025 (Вс) | 11.10.2025 (Сб) |

## API Endpoints

### GET /api/v1/digest/daily
Получить ежедневный дайджест

### GET /api/v1/digest/weekly
Получить еженедельный дайджест

### GET /api/v1/digest/custom?start_date=YYYY-MM-DD&end_date=YYYY-MM-DD
Получить дайджест за произвольный период

## Тестирование

Для проверки корректности логики расчета дат:

```bash
cd backend
python scripts/test_digest_dates.py
```

## Будущие улучшения

### 1. Поддержка часовых поясов пользователя
Добавить поле `timezone` в модель User для корректного расчета "текущего дня" относительно часового пояса пользователя.

### 2. Настраиваемое начало недели
Возможность выбора между воскресеньем и понедельником как первым днем недели в настройках пользователя.

### 3. Интеллектуальный выбор периода
Автоматическое определение оптимального периода на основе активности пользователя.

### 4. Предварительный просмотр дат
UI компонент для визуального подтверждения диапазона дат перед генерацией дайджеста.

## Технические детали

### Алгоритм расчета начала недели

```python
# weekday() возвращает: Monday=0, Tuesday=1, ..., Sunday=6
# Нам нужно: Sunday=0, Monday=1, ..., Saturday=6
days_since_sunday = (now.weekday() + 1) % 7

# Начало недели (воскресенье)
week_start = now - timedelta(days=days_since_sunday)
week_start = week_start.replace(hour=0, minute=0, second=0, microsecond=0)

# Конец недели (суббота)
days_until_saturday = 6 - days_since_sunday
week_end = now + timedelta(days=days_until_saturday)
week_end = week_end.replace(hour=23, minute=59, second=59, microsecond=999999)
```

## Известные ограничения

1. **UTC только**: Текущая реализация использует только UTC. Для учета местного времени пользователя требуется добавить поддержку часовых поясов.

2. **Переход на летнее время**: При использовании часовых поясов нужно будет корректно обрабатывать переходы на летнее/зимнее время.

3. **Культурные различия**: В некоторых странах (например, в России и большинстве европейских стран) неделя начинается с понедельника по ISO 8601. Текущая реализация использует воскресенье.

## Рекомендации

- Использовать `daily` для ежедневных обновлений
- Использовать `weekly` для еженедельных обзоров
- Использовать `custom` для специальных отчетов или анализа

